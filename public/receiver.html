<!DOCTYPE html>
<html>

<head>
  <link id="pagestyle" rel="stylesheet" type="text/css" href="rStart.css">
  <title>Cast Against Humanity</title>
</head>

<body>
  <audio autoplay>
    <source src="runescape-adventure.mp3" type="audio/mpeg">
  </audio>
  <div id="wfp">Waiting for Players</div>
  <!-- <div id="message"></div> -->
  <div id="playernames"></div>
</body>
<script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
<script type="text/javascript">
  //Player Array
  var playerArray = [];
  var playerNames = [];
  var blackCards=["The Natural History Museum has just opened an interactive exhibit on ________","Dear Agony Aunt, I’m having some trouble with ________ and I need your advice.","I’m sorry,Sir, but I couldn’t complete my homework because of ________.",'The theme for next year’s Eurovision Song Contest is “We are ________.”',"Nobody expects the Spanish Inquisition. Our chief weapons are fear, surprise, and ________.","When I am Prime Minister of the United Kingdom, I will create the Ministry of ________.","What kept Margaret Thatcher busy in her waning years?","In her latest feature-length film, Tracy Beaker struggles with ________ for the first time.","Airport security guidelines now prohibit ________ on airplanes.","The school field trip was completely ruined by ________.","What did I bring back from Amsterdam?","The TFL apologizes for the delay in train service due to ________.","Next on Sky Sports: The World Championship of ________.","Channel 5’s new reality show features eight washed-up celebrities living with ________.","Instead of coal, Father Christmas now gives bad children ________.","What are school administrators using to curb rampant teenage pregnancy?","________. That’s why mums go to Iceland.","Daddy, why is mummy crying?","When I’m in prison, I’ll have ______ smuggled in.","Who stole the cookies from the cookie jar.","Sorry everyone, I just ______.","I get by with a little help from ______.","Introducing X-Treme Baseball! It’s like baseball, but with ______!","The new Chevy Tahoe. With the power and space to take ______ everywhere you go.","What is George W. Bush thinking about right now?","And I would have gotten away with it, too, if it hadn’t been for ______!","He who controls ______ controls the world.","I learned the hard way that you can’t cheer up a grieving friend with ______.","In his new self-produced album, Kanye West raps over the sounds of ______.","In its new tourism campaign, Detroit proudly proclaims that it has finally eliminated ______.","In Rome, there are whisperings that the Vatican has a secret room devoted to ______.","In the distant future, historians will agree that ______ marked the beginning of America’s decline.","My plan for world domination begins with ______.","Next season on Man vs, Wild, Bear Grylls must survive the depths of the Amazon with only ______ and his wits.","Science will never explain ______.","Science will never explain the origin of ______.","The CIA now interrogates enemy agents by repeatedly subjecting them to ______.","The secret to a lasting marriage is communication, communication, and ______.","The socialist governments of Scandinavia have declared that access to ______ is a basic human right.","What has been making life difficult at the nudist colony?","What’s the gift that keeps on giving?",'After months of debate, the Occupy Wall Street General Assembly could only agree on “More ______!”',"Before I run for president, I must destroy all evidence of my involvement with ______.","Charades was ruined for me forever when my mom had to act out ______.","During his midlife crisis, my dad got really into ______.","Everyone down on the ground! We don’t want to hurt anyone. We’re just here for ______.","In his newest and most difficult stunt, David Blaine must escape from ______.","Little Miss Muffet Sat on a tuffet, Eating her curds and ______.","Members of New York’s social elite are paying thousands of dollars just to experience ______.","Next time on Dr. Phil: How to talk to your child about ______.","Only two things in life are certain: death and ______.","The Five Stages of Grief: denial, anger, bargaining, ______, acceptance.","The healing process began when I joined a support group for victims of ______.","The votes are in, and the new high school mascot is ______.","This is your captain speaking. Fasten your seatbelts and prepare for ______.","Tonight on 20/20: What you don’t know about ______ could kill you.","A remarkable new study has shown that chimps have evolved their own primitive version of _____.","What’s harshing my mellow, man?","Your persistence is admirable, my dear Prince. But you cannot win my heart with _____ alone."]  

  var cardDesc = ["A Burmese tiger pit.","A dollop of sour cream.","A fortuitous turnip harvest.","A piñata full of scorpions","A sad fat dragon with no friends.","A slightly worse parallel universe.",'A sofa that says “I have style, but I like to be comfortable.”','A soulful rendition of “Ol’ Man River.”',"A squadron of moles wearing aviator goggles.","A sweet spaceship.","All of this blood.","An army of skeletons.","An unhinged ferris wheel rolling toward the sea.","Another shot of morphine.","Basic human decency.","Beefin’ over turf.","Death by Steven Seagal.","Dennis the Menace.",'Dining with cardboard cutouts of the cast of “Friends.”',"Existing.","Fetal alcohol syndrome.","Finding Waldo.","Grandpa’s ashes.","Graphic violence, adult language, and some sexual content.","Hillary Clinton’s death stare.","Intimacy problems.","Living in a trashcan.","Making a friend.","Me.","Mild autism.","Mooing.","My first kill.","Nunchuck moves.","Oncoming traffic.","Power","Pretty Pretty Princess Dress-Up Board Game®.","Pumping out a baby every nine months.","Rising from the grave.","Special musical guest, Cher.","Spring break!","Subduing a grizzly bear and making her your wife.","Survivor’s guilt.","The black Power Ranger","The corporations.","The day the birds attacked.","The Google.","The human body.","The mixing of the races.","Tongue.","Upgrading homeless people to mobile hotspots.","Weapons-grade plutonium.","Wearing an octopus for a hat.","Whipping a disobedient slave.","Abstinence.","Goats eating coins.","Inappropriate yelling.","Vehicular homicide.","Filling Sean Hannity with helium and watching him float away.","A saxophone solo.","Bio-engineered assault turtles with acid breath.","Chunks of dead hitchhiker.","Court-ordered rehab.","Crumbs all over the god damn carpet.","Dark and mysterious forces beyond our control.","Giving birth to the Antichrist.","Hip hop jewels","Holding down a child and farting all over him.","Invading Poland.","Jobs.","Magnets.","Miley Cyrus at 55.","Our first chimpanzee President.",'Saying “I love you.”',"The cool, refreshing taste of Pepsi®.","The morbidly obese.","The Patriarchy.","The pirate’s life.","The rhythms of Africa","The wrath of Vladimir Putin","This year’s mass shooting","Your weird brother","The bloody Welsh","Blowing up Parliament","Badger culling","The sudden appearance of the Go Compare man","Women in yoghurt adverts","Some bloody peace and quiet","England","Madeleine McCann","A sober Irishman who doesn’t care for potatoes","An entrenched class system","The North","Rubbing Boris Johnson’s belly until he falls asleep","The Hillsborough Disaster","The end of days","Jedward","A madman who lives in a police box and kidnaps women","The Scouts","Getting naked and watching CBeebies","Ed Balls","Not wearing trousers","Cheating in the Paralympics","Anything that comes out of Prince Philip’s mouth","The Black Death","The Stig","Jehovah’s Witnesses","Blood, toil, tears, and sweat","An AK-47 assault rifle","Shipping convicts to Australia","A foetus","Ecstasy","The BNP","David Cameron","Just touching David Beckham’s hair","Extremely tight trousers","Trench foot","An argument with Richard Dawkins","The French","Dirty nappies","Germans on holiday","Paedophiles","Pronouncing the names of northern Welsh towns","Getting wed, having a few kids, taking some pictures, retiring to the south of France, and dying","Spaniards","Slapping a biscuit out of an orphan’s mouth","A white van man","Hurling one’s body down a hill in pursuit of a wheel of cheese","The entire cast of Downton Abbey","A thousand Scottish warriors lifting their kilts in unison","Tories","400 years of colonial atrocities","Faffing about","A nice cup of tea","Mining accidents","LYNX® Body Spray","Jimmy Savile","The way James Bond treats women","24-hour media coverage","A beached whale","A bloody pacifier","A fat bald man from the internet","A low standard of living","A nuanced critique","A panty raid","A passionate Latino lover","A plunger to the face","A rival dojo","A smiling black man, a latina businesswoman, a cool asian, and some whites","A web of lies","A woman scorned","An atomic wedgie","An evil man in evil clothes","Apologizing","Appreciative snapping","Beating your wives","Being a busy adult with many important things to do","Being a dinosaur","Bosnian chicken farmers","Breaking nip slip news","Clams","Carnies","Cutting","Dancing with a broom","Dorito breath","Eating an albino","Enormous Scandinavian women","Fabricating statistics","Finding a skeleton","Genetically engineered super-soldiers","Getting abducted by Peter Pan","Gladiatorial combat","Good grammar","Hipsters","Historical revisionism","Insatiable bloodlust","Jihad","Leveling up","Mad hacky-sack skills","Media coverage","Mom","Moral ambiguity","My machete","NOOOOOOOOO!!!","Ominous background music","Overpowering your father","Pistol-whipping a hostage","Quiche","Ripping into a man’s chest and pulling out his still-beating hear","Sanding off a man’s nose","Santa Claus","Savagely beating a mascot","Slow motion","Statistically validated stereotypes","Stockholm syndrome","Suicidal thoughts","The economy","The four arms of Vishnu","The harsh light of day","The hiccups","This guy!","Tripping balls","Words, words, words"]
  window.onload = function () {
    cast.receiver.logger.setLevelValue(0);
    window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
    console.log('Starting Receiver Manager');

    // handler for the 'ready' event
    castReceiverManager.onReady = function (event) {
      console.log('Received Ready event: ' + JSON.stringify(event.data));
      window.castReceiverManager.setApplicationState('Application status is ready...');
    };

    // handler for 'senderconnected' event
    castReceiverManager.onSenderConnected = function (event) {
      console.log('Received Sender Connected event: ' + event.data);
      console.log(window.castReceiverManager.getSender(event.data).userAgent);
    };

    // handler for 'senderdisconnected' event
    castReceiverManager.onSenderDisconnected = function (event) {
      console.log('Received Sender Disconnected event: ' + event.data);
      if (window.castReceiverManager.getSenders().length == 0) {
        window.close();
      }
    };

    // handler for 'systemvolumechanged' event
    castReceiverManager.onSystemVolumeChanged = function (event) {
      console.log('Received System Volume Changed event: ' + event.data['level'] + ' ' +
        event.data['muted']);
    };

    // create a CastMessageBus to handle messages for a custom namespace
    window.messageBusTrig =
      window.castReceiverManager.getCastMessageBus(
        'urn:x-cast:uk.co.jonfreer.cah.startTrig');

    window.messageBus =
      window.castReceiverManager.getCastMessageBus(
        'urn:x-cast:uk.co.jonfreer.cah.join');



    // ON PLAYER JOIN AT START
    // handler for the CastMessageBus message event
    window.messageBus.onMessage = function (event) {
      console.log('Message [' + event.senderId + ']: ' + event.data);
      // display the message from the sender
      playerArray.push({ sendID: event.senderId, name: event.data, score: 0, currentCard: null });
      playerNames.push(event.data)
      //window.broadcast(playerArray);

      //console.log(playerArray.toString())
      window.messageBus.broadcast(playerNames.toString())
      displayText();//event.data);
      //displayText(senderId);
      // inform all senders on the CastMessageBus of the incoming message event
      // sender message listener will be invoked

      //window.messageBus.send(event.senderId, event.data);
    }

    // initialize the CastReceiverManager with an application status message
    window.castReceiverManager.start({ statusText: 'Application is starting' });
    console.log('Receiver Manager started');

    // create a CastMessageBus to handle messages for a custom namespace for trig

    window.messageBusTrig.onMessage = function (event) {
      console.log(event.data);
      if (event.data == "Start Game") {
        window.messageBusTrig.broadcast("GameBegin");
        console.log("GameBegin");
        window.castReceiverManager.setApplicationState("Game Active");
        initGame();
      }
      else if (event.data.substring(0, 2) == "pS") {
        console.log("YEBOOIIII");
        window.wCardOrder.push(event.data.substring(2));
        playerArray[getIDfromSender(event.senderId)].currentCard = event.data.substring(2);
        currentCards.push(event.data.substring(2));
        window.messageBusTrig.send(event.senderId, "caUp"+window.wCardOrder.splice(0,1));//cardupdate
        document.getElementById("main").innerHTML=document.getElementById("main").innerHTML+ '<div class="white" id="w'+(currentCards.length-1)+'"></div>';
        
        //callback:// 2d array to store player id (DONE)
        if (currentCards.length == playerArray.length - 1) {
          vote();
        }

      }
      else if (event.data.substring(0, 2) == "cS") {
        console.log(event.data)
        document.getElementById("w" + event.data.substring(2)).style.color = "#30fc2d";
        playerArray[getIDfromCard(currentCards[event.data.substring(2)])].score++;
        console.log(playerArray);
        updateScore();
        setTimeout(nextTurn, 5000);

      }


    }

  };

  function getIDfromSender(sID) {
    for (i = 0; i < playerArray.length; i++) {
      if (playerArray[i].sendID == sID) {
        return i;
      }
    }
  }

  function getIDfromCard(cID) {
    for (i = 0; i < playerArray.length; i++) {
      if (playerArray[i].currentCard == cID) {
        return i;
      }
    }
  }

  function swapStyleSheet(sheet) {
    document.getElementById("pagestyle").setAttribute("href", sheet);
  }

  function initGame() {
    window.currentCards = []
    window.wCardOrder = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99,100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199,200,201]
    wCardOrder = shuffleArray(wCardOrder);
    blackCards = shuffleArray(blackCards);
    console.log(wCardOrder);
    for (i = 0; i < playerArray.length; i++) {
      dealPlayer(playerArray[i].sendID)
    }
    swapStyleSheet("rMain.css")

    document.getElementsByTagName("BODY")[0].innerHTML = '<div id= "scoreboard">Score<div id="scores"></div></div><div id= "main"></div>'
    window.czar = -1;
    window.bCount=-1;
    updateScore();
    
    nextTurn();
    //<div id="black">The Natural History Museum has just opened an interactive exhibit on ________.</div>    <div class="white" id="w0"></div><div class="white" id="w1"> </div><div class="white" id="w2"> </div><div class="white" id="w3"> </div><div class="white"id="w4"> </div><div class="white" id="w5"> </div><div class="white"id="w6"> </div><div class="white" id="w7"> </div>
  };

  function nextTurn() {
    if (bCount < blackCards.length - 1) { bCount++ } 
    else { bCount = 0 }
    document.getElementById("main").innerHTML='<div id="black">'+blackCards[bCount]+'</div>';
    currentCards = []
    if (czar < playerArray.length - 1) { czar++ }
    else { czar = 0 }
    console.log("czar", czar)
    window.messageBusTrig.send(playerArray[czar].sendID, "Czar");
    for (i = 0; i < playerArray.length; i++) {
      if(i!=czar){
        window.messageBusTrig.send(playerArray[i].sendID, "newR");
      }
    }
    updateScore();
    



  }

  function updateScore() {
    scoreHTML = ""
    for (i = 0; i < playerArray.length; i++) {
      console.log(czar, i)
      if (i == czar) { scoreHTML = scoreHTML + "<u>" + playerArray[i].name + "</u>" + "&nbsp &nbsp &nbsp" + playerArray[i].score + "</br>"; } else {
        scoreHTML = scoreHTML + playerArray[i].name + "&nbsp &nbsp &nbsp" + playerArray[i].score + "</br>";
      }
    }
    document.getElementById("scores").innerHTML = scoreHTML;
  }


  function vote() {
    for (i = 0; i < currentCards.length; i++) {
      document.getElementById("w" + i).innerHTML = cardDesc[currentCards[i]]
    }
    console.log("cz",czar,playerArray)
    window.messageBusTrig.send(playerArray[czar].sendID, "Vote" + currentCards.toString());
  }

  function dealPlayer(sendID) {
    playerCards = window.wCardOrder.splice(0, 10);
    console.log(sendID, playerCards);
    window.messageBusTrig.send(sendID, "Init" + playerCards.toString());


  };

  function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
    return array;
  };

  // utility function to display the text message in the input field
  function displayText() {
    document.getElementById("playernames").innerHTML = "";
    for (i = 0; i < playerArray.length; i++) {
      document.getElementById("playernames").innerHTML = document.getElementById("playernames").innerHTML + "<div>" + playerArray[i].name; "</div>";
    }
    //console.log(text);
    //document.getElementById('message').innerText = text;
    window.castReceiverManager.setApplicationState("Game Warmup");
  };

</script>

</html>