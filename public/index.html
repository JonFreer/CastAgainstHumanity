<html>

<head>
    <title>Cast Against Humanity </title>
    <link id="pagestyle" rel="stylesheet" type="text/css" href="start.css">
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script type="text/javascript">
        var applicationID = "43BD0076";/*'794B7BBF';*/
        var namespace = 'urn:x-cast:uk.co.jonfreer.cah.join';
        var session = null;
        var cardDesc = ["A Burmese tiger pit.","A dollop of sour cream.","A fortuitous turnip harvest.","A piñata full of scorpions","A sad fat dragon with no friends.","A slightly worse parallel universe.",'A sofa that says “I have style, but I like to be comfortable.”','A soulful rendition of “Ol’ Man River.”',"A squadron of moles wearing aviator goggles.","A sweet spaceship.","All of this blood.","An army of skeletons.","An unhinged ferris wheel rolling toward the sea.","Another shot of morphine.","Basic human decency.","Beefin’ over turf.","Death by Steven Seagal.","Dennis the Menace.",'Dining with cardboard cutouts of the cast of “Friends.”',"Existing.","Fetal alcohol syndrome.","Finding Waldo.","Grandpa’s ashes.","Graphic violence, adult language, and some sexual content.","Hillary Clinton’s death stare.","Intimacy problems.","Living in a trashcan.","Making a friend.","Me.","Mild autism.","Mooing.","My first kill.","Nunchuck moves.","Oncoming traffic.","Power","Pretty Pretty Princess Dress-Up Board Game®.","Pumping out a baby every nine months.","Rising from the grave.","Special musical guest, Cher.","Spring break!","Subduing a grizzly bear and making her your wife.","Survivor’s guilt.","The black Power Ranger","The corporations.","The day the birds attacked.","The Google.","The human body.","The mixing of the races.","Tongue.","Upgrading homeless people to mobile hotspots.","Weapons-grade plutonium.","Wearing an octopus for a hat.","Whipping a disobedient slave.","Abstinence.","Goats eating coins.","Inappropriate yelling.","Vehicular homicide.","Filling Sean Hannity with helium and watching him float away.","A saxophone solo.","Bio-engineered assault turtles with acid breath.","Chunks of dead hitchhiker.","Court-ordered rehab.","Crumbs all over the god damn carpet.","Dark and mysterious forces beyond our control.","Giving birth to the Antichrist.","Hip hop jewels","Holding down a child and farting all over him.","Invading Poland.","Jobs.","Magnets.","Miley Cyrus at 55.","Our first chimpanzee President.",'Saying “I love you.”',"The cool, refreshing taste of Pepsi®.","The morbidly obese.","The Patriarchy.","The pirate’s life.","The rhythms of Africa","The wrath of Vladimir Putin","This year’s mass shooting","Your weird brother","The bloody Welsh","Blowing up Parliament","Badger culling","The sudden appearance of the Go Compare man","Women in yoghurt adverts","Some bloody peace and quiet","England","Madeleine McCann","A sober Irishman who doesn’t care for potatoes","An entrenched class system","The North","Rubbing Boris Johnson’s belly until he falls asleep","The Hillsborough Disaster","The end of days","Jedward","A madman who lives in a police box and kidnaps women","The Scouts","Getting naked and watching CBeebies","Ed Balls","Not wearing trousers","Cheating in the Paralympics","Anything that comes out of Prince Philip’s mouth","The Black Death","The Stig","Jehovah’s Witnesses","Blood, toil, tears, and sweat","An AK-47 assault rifle","Shipping convicts to Australia","A foetus","Ecstasy","The BNP","David Cameron","Just touching David Beckham’s hair","Extremely tight trousers","Trench foot","An argument with Richard Dawkins","The French","Dirty nappies","Germans on holiday","Paedophiles","Pronouncing the names of northern Welsh towns","Getting wed, having a few kids, taking some pictures, retiring to the south of France, and dying","Spaniards","Slapping a biscuit out of an orphan’s mouth","A white van man","Hurling one’s body down a hill in pursuit of a wheel of cheese","The entire cast of Downton Abbey","A thousand Scottish warriors lifting their kilts in unison","Tories","400 years of colonial atrocities","Faffing about","A nice cup of tea","Mining accidents","LYNX® Body Spray","Jimmy Savile","The way James Bond treats women","24-hour media coverage","A beached whale","A bloody pacifier","A fat bald man from the internet","A low standard of living","A nuanced critique","A panty raid","A passionate Latino lover","A plunger to the face","A rival dojo","A smiling black man, a latina businesswoman, a cool asian, and some whites","A web of lies","A woman scorned","An atomic wedgie","An evil man in evil clothes","Apologizing","Appreciative snapping","Beating your wives","Being a busy adult with many important things to do","Being a dinosaur","Bosnian chicken farmers","Breaking nip slip news","Clams","Carnies","Cutting","Dancing with a broom","Dorito breath","Eating an albino","Enormous Scandinavian women","Fabricating statistics","Finding a skeleton","Genetically engineered super-soldiers","Getting abducted by Peter Pan","Gladiatorial combat","Good grammar","Hipsters","Historical revisionism","Insatiable bloodlust","Jihad","Leveling up","Mad hacky-sack skills","Media coverage","Mom","Moral ambiguity","My machete","NOOOOOOOOO!!!","Ominous background music","Overpowering your father","Pistol-whipping a hostage","Quiche","Ripping into a man’s chest and pulling out his still-beating hear","Sanding off a man’s nose","Santa Claus","Savagely beating a mascot","Slow motion","Statistically validated stereotypes","Stockholm syndrome","Suicidal thoughts","The economy","The four arms of Vishnu","The harsh light of day","The hiccups","This guy!","Tripping balls","Words, words, words"]
        /**
 * Call initialization for Cast
 */
        if (!chrome.cast || !chrome.cast.isAvailable) {
            setTimeout(initializeCastApi, 1000);
        }

        /**
           * initialization
           */
        function initializeCastApi() {
            var sessionRequest = new chrome.cast.SessionRequest(applicationID);
            var apiConfig = new chrome.cast.ApiConfig(sessionRequest,
                sessionListener,
                receiverListener);

            chrome.cast.initialize(apiConfig, onInitSuccess, onError);
        }

        /**
         * initialization success callback
         */
        function onInitSuccess() {
            appendMessage('onInitSuccess');
        }

        /**
         * initialization error callback
         */
        function onError(message) {
            appendMessage('onError: ' + JSON.stringify(message));
        }

        /**
         * generic success callback
         */
        function onSuccess(message) {
            appendMessage('onSuccess: ' + message);
        }

        /**
         * callback on success for stopping app
         */
        function onStopAppSuccess() {
            appendMessage('onStopAppSuccess');
        }

        function appendMessage(message) {
            console.log(message);
        }
        /**
        * session listener during initialization
        */
        function sessionListener(e) {
            appendMessage('New session ID:' + e.sessionId);
            session = e;
            session.addUpdateListener(sessionUpdateListener);
            console.log("brr")
            session.addMessageListener(namespace, receiverMessage);
        }
        //Session listener for players joined


        /**
         * listener for session updates
         */
        function sessionUpdateListener(isAlive) {
            var message = isAlive ? 'Session Updated' : 'Session Removed';
            message += ': ' + session.sessionId;
            appendMessage(message);
            if (!isAlive) {
                session = null;
            }
        }

        /**
         * utility function to log messages from the receiver
         * @param {string} namespace The namespace of the message
         * @param {string} message A message string
         */
        function receiverMessage(namespace, message) {
            appendMessage('receiverMessage: ' + namespace + ', ' + message);
        }

        /**
         * receiver listener during initialization
         */
        function receiverListener(e) {
            if (e === 'available') {
                appendMessage('receiver found');
            }
            else {
                appendMessage('receiver list empty');
            }
        }

        /**
         * stop app/session
         */
        function stopApp() {
            session.stop(onStopAppSuccess, onError);
        }

        /**
         * send a message to the receiver using the custom namespace
         * receiver CastMessageBus message handler will be invoked
         * @param {string} message A message string
         */
        function sendMessage(message) {
            if (session != null) {
                session.sendMessage(namespace, message, joinGame(), //Message sent:
                    onError);
            }
            else {
                chrome.cast.requestSession(function (e) {
                    session = e;
                    session.sendMessage(namespace, message, joinGame(), onError);
                }, onError);
            }


        }

        /**
         * utility function to handle text typed in by user in the input field
         */
        function update() {
            sendMessage(document.getElementById('input').value);
        }
        function swapStyleSheet(sheet) {
            document.getElementById("pagestyle").setAttribute("href", sheet);
        }

        function joinGame() {
            /*var rule = document.styleSheets[styleIndex][cssRuleCode][ruleIndex];
            var selector = rule.selectorText;  //maybe '#tId'
            var value = rule.value;   */
            swapStyleSheet("joined.css")
            document.getElementsByTagName("BODY")[0].innerHTML = '<div id="wfp">Waiting for Players</div> <div id="playernames"></div> <button onclick="startTrig()" id = "startgame">Start Game</button>';
            session.addMessageListener(namespace, function (ns, message) {
                window.playerArray = message.split(",")
                console.log(playerArray);
                document.getElementById("playernames").innerHTML = "";
                for (i = 0; i < playerArray.length; i++) {
                    document.getElementById("playernames").innerHTML = document.getElementById("playernames").innerHTML + "<div>" + playerArray[i] + "</div>";
                }
            });

            console.log("Joined Game");
            session.addMessageListener('urn:x-cast:uk.co.jonfreer.cah.startTrig', function (ns, message) {
                //console.log(message)
                if (message == "GameBegin") {
                    console.log("GameBegins");
                    initGame();
                }
                else if (message.substring(0, 4) == "Init") {
                    console.log(message);
                    window.cardArray = message.substring(4).split(",")
                    initDeal();
                } else if (message == "Czar") {
                    initCzar();
                    console.log("czar");
                } else if (message.substring(0, 4) == "Vote") {
                    updateCzar(message.substring(4));
                } else if (message.substring(0, 4) == "caUp") {
                    cardArray.push(message.substring(4));
                }
                else if (message == "newR") {
                    initGame();
                    initDeal();
                }
                else { console.log("else" + message) }
            }
            );

        }
        function startTrig() {
            namespace2 = 'urn:x-cast:uk.co.jonfreer.cah.startTrig';
            console.log(session);
            session.sendMessage('urn:x-cast:uk.co.jonfreer.cah.startTrig', "Start Game", console.log("Trig"), onError);
        }

        function initGame() {
            document.getElementsByTagName("BODY")[0].innerHTML = "";
            swapStyleSheet("sMain.css");
            document.getElementsByTagName("BODY")[0].innerHTML = '<div class="white" id="card0" onclick="bClick(0)"></div><div class="white" id="card1" onclick="bClick(1)"> </div><div class="white" id="card2" onclick="bClick(2)"> </div><div class="white" id="card3" onclick="bClick(3)"> </div><div class="white" id="card4" onclick="bClick(4)"> </div><div class="white" id="card5" onclick="bClick(5)"> </div><div class="white" id="card6" onclick="bClick(6)"> </div><div class="white" id="card7" onclick="bClick(7)"> </div><div class="white" id="card8" onclick="bClick(8)"> </div><div class="white" id="card9" onclick="bClick(9)"> </div>';

            window.selected = false;
        }

        function initDeal(message) {

            for (i = 0; i < cardArray.length; i++) {
                document.getElementById("card" + i).innerHTML = cardDesc[cardArray[i]]
            }
            window.selected = false;
        }
        function bClick(id) {
            console.log(id);//selected needs to be reset each round
            if (selected != true) {
                document.getElementById("card" + id).style.background = "#d0d0d0";
                selected = true;
                session.sendMessage('urn:x-cast:uk.co.jonfreer.cah.startTrig', "pS" + cardArray[id], console.log("Trig"), onError);//pS=playerSubmit
            }
            //initCzar()   
        }

        function initCzar() {
            document.getElementsByTagName("BODY")[0].innerHTML = ""
            swapStyleSheet("cMain.css");
            bodytext = '<div id ="czar">You are the Card Czar</div>'
            console.log("playerArray", playerArray)
            for (i = 0; i < playerArray.length - 1; i++) {
                bodytext = bodytext + '<div class="white" id="w' + i + '" onclick="czarClick(' + i + ')"> </div>';
                console.log("playerArray", playerArray, i)
            }
            document.getElementsByTagName("BODY")[0].innerHTML = bodytext;
            selected = true;

        }
        function updateCzar(message) {
            console.log("updatecz", message)
            selected = false;
            window.czarArray = message.split(",")
            for (i = 0; i < czarArray.length; i++) {
                document.getElementById("w" + i).innerHTML = cardDesc[czarArray[i]]
            }

        }

        function czarClick(id) {
            if (selected != true) {
                document.getElementById("w" + id).style.background = "#d0d0d0";
                selected = true;
                session.sendMessage('urn:x-cast:uk.co.jonfreer.cah.startTrig', "cS" + id, console.log("Trig"), onError);//cS=czarSubmit
            }
        }
    </script>
</head>

<body>
    <h1>Cast Against Humanity </h1>
    <form method="get" action="JavaScript:update();">
        <input id="input" class="border" type="text" size="30" autocomplete="off" placeholder="Nickname" onwebkitspeechchange="transcribe(this.value)"
            x-webkit-speech/>
    </form>
</body>

</html>